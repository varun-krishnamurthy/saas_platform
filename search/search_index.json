{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"SaaS Platform","text":"<p>A multi-tenant SaaS foundation for Frappe/ERPNext, designed to manage tenant lifecycle, data isolation, and central authentication.</p>"},{"location":"#core-pillars","title":"Core Pillars","text":"<ul> <li>Multi-Tenancy: Native row-level isolation using <code>tenant_id</code>.</li> <li>Central Authentication: Unified session management for the entire microservice ecosystem.</li> <li>Tenant Lifecycle: Automated onboarding from signup to site provisioning.</li> <li>Microservice Enabler: Provides the critical metadata required for secure microservice integration.</li> </ul>"},{"location":"#navigation","title":"Navigation","text":"<ul> <li>Architecture Guide</li> <li>Implementation Details</li> <li>Microservice Integration</li> <li>Installation Guide</li> </ul>"},{"location":"architecture/","title":"Multi-Tenant SaaS Architecture","text":""},{"location":"architecture/#overview","title":"Overview","text":"<p>This document describes the multi-tenant architecture implemented on top of ERPNext/Frappe for delivering ERPNext as a SaaS platform.</p>"},{"location":"architecture/#core-concepts","title":"Core Concepts","text":""},{"location":"architecture/#tenant","title":"Tenant","text":"<p>A Tenant represents a customer organization subscribing to your SaaS platform. Each tenant:</p> <ul> <li>Has a unique <code>tenant_id</code> (e.g., <code>acme-corp-a1b2c3d4</code>)</li> <li>Can have multiple Companies (for their own accounting)</li> <li>Has one Subscription linking them to a Subscription Plan</li> <li>Has isolated data - they only see their own records</li> </ul>"},{"location":"architecture/#data-isolation","title":"Data Isolation","text":"<p>All business data is isolated by <code>tenant_id</code>:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        ERPNext Database                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  tenant_id = \"SYSTEM\"     \u2502  Shared/Platform data               \u2502\n\u2502  (Customers, Subscriptions for billing)                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  tenant_id = \"acme-abc123\" \u2502  Tenant A's data                   \u2502\n\u2502  (Companies, Items, Orders, Invoices, etc.)                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  tenant_id = \"globex-def456\" \u2502  Tenant B's data                 \u2502\n\u2502  (Companies, Items, Orders, Invoices, etc.)                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#entity-relationships","title":"Entity Relationships","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                           PLATFORM LAYER (tenant_id = SYSTEM)            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502   Tenant    \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502    Customer      \u2502\u25c0\u2500\u2500\u2500\u2500\u2500\u2502   Subscription   \u2502 \u2502\n\u2502  \u2502             \u2502         \u2502 (YOUR customer   \u2502      \u2502                  \u2502 \u2502\n\u2502  \u2502 tenant_id   \u2502         \u2502  for billing)    \u2502      \u2502 party_type:      \u2502 \u2502\n\u2502  \u2502 tenant_name \u2502         \u2502                  \u2502      \u2502   Customer       \u2502 \u2502\n\u2502  \u2502 subdomain   \u2502         \u2502 tenant_id=SYSTEM \u2502      \u2502 party: Customer  \u2502 \u2502\n\u2502  \u2502 admin_email \u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502                  \u2502 \u2502\n\u2502  \u2502 subscription\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502 plans: [         \u2502 \u2502\n\u2502  \u2502 status      \u2502                                   \u2502   Free Plan      \u2502 \u2502\n\u2502  \u2502 trial_expiry\u2502                                   \u2502 ]                \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                   \u2502 tenant_id=SYSTEM \u2502 \u2502\n\u2502                                                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                             \u2502           \u2502\n\u2502                                                             \u25bc           \u2502\n\u2502                                                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502                                                 \u2502  Subscription Plan   \u2502\u2502\n\u2502                                                 \u2502  (Free Plan, Pro,    \u2502\u2502\n\u2502                                                 \u2502   Enterprise, etc.)  \u2502\u2502\n\u2502                                                 \u2502  tenant_id=SYSTEM    \u2502\u2502\n\u2502                                                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      TENANT DATA LAYER (tenant_id = tenant's ID)         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                  \u2502\n\u2502  \u2502  Company 1  \u2502    \u2502  Company 2  \u2502    \u2502  Company N  \u2502                  \u2502\n\u2502  \u2502  (tenant's  \u2502    \u2502  (tenant's  \u2502    \u2502  (tenant's  \u2502                  \u2502\n\u2502  \u2502   own co.)  \u2502    \u2502   own co.)  \u2502    \u2502   own co.)  \u2502                  \u2502\n\u2502  \u2502             \u2502    \u2502             \u2502    \u2502             \u2502                  \u2502\n\u2502  \u2502 tenant_id=  \u2502    \u2502 tenant_id=  \u2502    \u2502 tenant_id=  \u2502                  \u2502\n\u2502  \u2502 acme-abc123 \u2502    \u2502 acme-abc123 \u2502    \u2502 acme-abc123 \u2502                  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518                  \u2502\n\u2502         \u2502                  \u2502                  \u2502                          \u2502\n\u2502         \u25bc                  \u25bc                  \u25bc                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                     All Business Documents                          \u2502 \u2502\n\u2502  \u2502  Sales Orders, Purchase Orders, Invoices, Items, Stock Entries,   \u2502 \u2502\n\u2502  \u2502  Journal Entries, Customers (tenant's customers), Suppliers, etc.  \u2502 \u2502\n\u2502  \u2502                                                                     \u2502 \u2502\n\u2502  \u2502  All have: tenant_id = \"acme-abc123\"                               \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#tenant-onboarding-flow","title":"Tenant Onboarding Flow","text":"<p>When a new tenant signs up:</p> <pre><code>1. Create Tenant\n   \u251c\u2500\u2500 Generate unique tenant_id (e.g., \"acme-corp-a1b2c3d4\")\n   \u2502\n2. Create Customer (tenant_id = SYSTEM)\n   \u251c\u2500\u2500 This is YOUR customer for billing purposes\n   \u251c\u2500\u2500 Visible to platform administrators\n   \u2502\n3. Create Company (tenant_id = tenant's ID)\n   \u251c\u2500\u2500 This is the tenant's default company\n   \u251c\u2500\u2500 Only visible to the tenant\n   \u2502\n4. Create/Update Admin User (tenant_id = tenant's ID)\n   \u251c\u2500\u2500 User is linked to tenant via tenant_id\n   \u251c\u2500\u2500 Roles: System Manager, Accounts Manager, etc.\n   \u251c\u2500\u2500 On login, tenant_id is set in session\n   \u2502\n5. Create Subscription (tenant_id = SYSTEM)\n   \u251c\u2500\u2500 Links Customer to Subscription Plan\n   \u251c\u2500\u2500 Sets trial period (14 days)\n   \u2514\u2500\u2500 Status: Trialling\n</code></pre>"},{"location":"architecture/#user-tenant-linking","title":"User-Tenant Linking","text":""},{"location":"architecture/#session-management","title":"Session Management","text":"<p>When a user logs in, the <code>on_session_creation</code> hook sets <code>tenant_id</code> in the session:</p> <pre><code># hooks.py\non_session_creation = \"saas_platform.utils.tenant.on_session_creation\"\n</code></pre> <pre><code># utils/tenant.py\ndef on_session_creation(login_manager):\n    user = login_manager.user\n\n    # Administrator always gets SYSTEM\n    if user == \"Administrator\":\n        frappe.session['tenant_id'] = \"SYSTEM\"\n        return\n\n    # Get tenant_id from User document\n    user_doc = frappe.get_doc(\"User\", user)\n    if user_doc.tenant_id:\n        frappe.session['tenant_id'] = user_doc.tenant_id\n</code></pre>"},{"location":"architecture/#user-custom-field","title":"User Custom Field","text":"<p>User DocType has a <code>tenant_id</code> Custom Field:</p> <ul> <li>Read-only (set automatically)</li> <li>Visible in list view for administrators</li> <li>Used for session tenant_id lookup</li> </ul>"},{"location":"architecture/#database-schema","title":"Database Schema","text":""},{"location":"architecture/#tenant_id-column","title":"tenant_id Column","text":"<p>Added to 689+ tables via ALTER TABLE:</p> <pre><code>ALTER TABLE `tabCompany` ADD COLUMN `tenant_id` VARCHAR(255);\nCREATE INDEX `idx_tenant_id` ON `tabCompany` (`tenant_id`);\n</code></pre>"},{"location":"architecture/#custom-fields","title":"Custom Fields","text":"<p>Added <code>tenant_id</code> Custom Field to 21 core DocTypes:</p> <ul> <li>Company, Customer, Supplier, Item</li> <li>Sales Order, Purchase Order, Sales Invoice, Purchase Invoice</li> <li>Quotation, Payment Entry, Journal Entry</li> <li>Delivery Note, Purchase Receipt, Stock Entry</li> <li>Lead, Opportunity, Project, Task, Issue</li> <li>Contact, Address</li> </ul>"},{"location":"architecture/#permission-system","title":"Permission System","text":""},{"location":"architecture/#hooks-configuration-hookspy","title":"Hooks Configuration (hooks.py)","text":"<pre><code>doc_events = {\n    \"*\": {\n        \"before_insert\": \"saas_platform.utils.set_tenant_id\"\n    }\n}\n\npermission_query_conditions = {\n    \"*\": \"saas_platform.utils.tenant.get_permission_query_conditions\"\n}\n</code></pre>"},{"location":"architecture/#automatic-tenant_id-assignment","title":"Automatic tenant_id Assignment","text":"<p>When any document is created, <code>set_tenant_id()</code> automatically sets:</p> <ul> <li><code>tenant_id</code> = current user's tenant_id</li> <li>Skips system doctypes (User, Role, DocType, Tenant, Subscription, etc.)</li> <li>Administrator bypass (no tenant_id set)</li> </ul>"},{"location":"architecture/#query-filtering","title":"Query Filtering","text":"<p><code>get_permission_query_conditions()</code> returns SQL WHERE clause:</p> <pre><code>-- For regular users:\n(tenant_id = 'user_tenant_id' OR tenant_id = 'SYSTEM' OR tenant_id IS NULL)\n\n-- For Administrator:\nNULL (no filtering - sees everything)\n</code></pre>"},{"location":"architecture/#system-doctypes-excluded-from-tenant-isolation","title":"System DocTypes (Excluded from Tenant Isolation)","text":"<p>These DocTypes are shared across all tenants:</p> <pre><code>system_doctypes = [\n    'User', 'Role', 'DocType', 'DocField', 'DocPerm', 'Module Def',\n    'Domain', 'Domain Settings', 'Tenant', 'Plan', 'Subscription Plan',\n    'Subscription', 'Subscription Plan Detail', 'Customer',\n    'Workspace', 'Workflow', 'Print Format', 'Email Template',\n    'System Settings', 'Website Settings', 'Portal Settings',\n    'Error Log', 'Activity Log', 'Version', 'Communication',\n    'Comment', 'File', 'Custom Field'\n]\n</code></pre>"},{"location":"architecture/#user-access-matrix","title":"User Access Matrix","text":"User Type See Own Tenant Data See SYSTEM Data See All Data Tenant User \u2705 \u2705 \u274c Tenant Admin \u2705 \u2705 \u274c Platform Administrator \u2705 \u2705 \u2705"},{"location":"architecture/#key-files","title":"Key Files","text":"File Purpose <code>saas_platform/doctype/tenant/tenant.py</code> Tenant business logic, auto-creation of Customer, Company, Subscription <code>saas_platform/doctype/tenant/tenant.json</code> Tenant DocType definition <code>saas_platform/utils/tenant.py</code> Tenant isolation utilities (set_tenant_id, get_permission_query_conditions) <code>saas_platform/hooks.py</code> Frappe hooks for doc_events and permission_query_conditions <code>saas_platform/utils/add_tenant_columns.py</code> Migration utility to add tenant_id to all tables <code>saas_platform/utils/add_custom_fields.py</code> Utility to add tenant_id Custom Fields"},{"location":"architecture/#erpnext-integration","title":"ERPNext Integration","text":""},{"location":"architecture/#subscription-plan-erpnext-built-in","title":"Subscription Plan (ERPNext Built-in)","text":"<p>Uses ERPNext's native Subscription Plan DocType:</p> <ul> <li><code>plan_name</code>: \"Free Plan\", \"Pro Plan\", etc.</li> <li><code>item</code>: Link to Item DocType</li> <li><code>cost</code>: Monthly/yearly cost</li> <li><code>billing_interval</code>: Day/Week/Month/Year</li> <li><code>currency</code>: System default currency</li> </ul>"},{"location":"architecture/#subscription-erpnext-built-in","title":"Subscription (ERPNext Built-in)","text":"<p>Uses ERPNext's native Subscription DocType:</p> <ul> <li><code>party_type</code>: \"Customer\"</li> <li><code>party</code>: Link to Customer</li> <li><code>plans</code>: Child table with Subscription Plans</li> <li>Manages trial periods, invoicing, renewals</li> </ul>"},{"location":"architecture/#example-complete-tenant-data","title":"Example: Complete Tenant Data","text":"<pre><code>Tenant: Acme Corporation\n\u251c\u2500\u2500 tenant_id: acme-corp-a1b2c3d4\n\u251c\u2500\u2500 subdomain: acme\n\u251c\u2500\u2500 admin_email: admin@acme.com\n\u251c\u2500\u2500 status: Trial\n\u251c\u2500\u2500 trial_expiry: 2025-12-28\n\u2502\n\u251c\u2500\u2500 Customer: Acme Corporation (tenant_id: SYSTEM)\n\u2502   \u2514\u2500\u2500 For platform billing\n\u2502\n\u251c\u2500\u2500 Subscription: ACC-SUB-2025-00001 (tenant_id: SYSTEM)\n\u2502   \u251c\u2500\u2500 Party: Customer - Acme Corporation\n\u2502   \u251c\u2500\u2500 Status: Trialling\n\u2502   \u2514\u2500\u2500 Plan: Free Plan\n\u2502\n\u2514\u2500\u2500 Company: Acme Corporation (tenant_id: acme-corp-a1b2c3d4)\n    \u2514\u2500\u2500 Tenant's own company for their accounting\n        \u251c\u2500\u2500 Items (tenant_id: acme-corp-a1b2c3d4)\n        \u251c\u2500\u2500 Sales Orders (tenant_id: acme-corp-a1b2c3d4)\n        \u251c\u2500\u2500 Invoices (tenant_id: acme-corp-a1b2c3d4)\n        \u2514\u2500\u2500 ... all business data\n</code></pre>"},{"location":"architecture/#security-considerations","title":"Security Considerations","text":"<ol> <li>Row-Level Security: All queries automatically filtered by tenant_id</li> <li>Administrator Bypass: Only system Administrator can see all data</li> <li>SYSTEM tenant_id: Platform data (subscriptions, billing) isolated from tenant data</li> <li>Custom Field Protection: tenant_id fields are hidden, read-only, no-copy</li> </ol>"},{"location":"architecture/#future-enhancements","title":"Future Enhancements","text":"<ul> <li>[ ] Tenant-specific user management</li> <li>[ ] Subdomain-based routing</li> <li>[ ] Usage-based billing integration</li> <li>[ ] Tenant data export/import</li> <li>[ ] Cross-tenant reporting for administrators</li> </ul>"},{"location":"implementation/","title":"Multi-Tenant Implementation Summary","text":""},{"location":"implementation/#overview","title":"Overview","text":"<p>Successfully implemented comprehensive single-site multi-tenancy for saas_platform app with tenant_id isolation across ALL DocTypes.</p>"},{"location":"implementation/#components-implemented","title":"Components Implemented","text":""},{"location":"implementation/#1-plan-doctype","title":"1. Plan DocType","text":"<p>Location: <code>saas_platform/saas_platform/doctype/plan/</code></p> <p>Fields: - <code>plan_name</code> (Data, unique) - e.g., \"Free Plan\", \"Business Basic\", \"Business Pro\" - <code>plan_type</code> (Select) - Free/Business Basic/Business Pro - <code>price</code> (Currency) - Monthly pricing - <code>billing_cycle</code> (Select) - Monthly/Yearly - <code>max_users</code> (Int) - User limit (-1 for unlimited) - <code>max_storage_gb</code> (Int) - Storage limit in GB - <code>features</code> (Text) - Feature description - <code>tenant_id</code> (Data, default=\"SYSTEM\") - Shared plans accessible to all tenants</p> <p>Fixtures: Three default plans pre-configured in <code>saas_platform/fixtures/plan.json</code> - Free Plan: $0, 3 users, 5GB - Business Basic: $29.99, 10 users, 50GB - Business Pro: $99.99, unlimited users, 500GB</p>"},{"location":"implementation/#2-enhanced-tenant-doctype","title":"2. Enhanced Tenant DocType","text":"<p>Location: <code>saas_platform/saas_platform/doctype/tenant/</code></p> <p>New Fields: - <code>tenant_id</code> (Data, unique, indexed, hidden) - Auto-generated unique identifier - <code>company</code> (Link to Company) - Auto-created ERPNext Company - <code>current_subscription</code> (Link to Subscription) - Links to ERPNext's Subscription DocType</p> <p>Lifecycle Hooks: - <code>before_insert()</code>: Generates unique tenant_id slug (e.g., \"acme-corp-a3b8c9d2\") - <code>validate()</code>: Ensures subdomain and admin_email uniqueness - <code>after_insert()</code>: Automatically creates:   1. ERPNext Company (with unique abbreviation)   2. ERPNext Subscription (linked to Free Plan with 14-day trial)</p> <p>No Custom Subscription: Reuses ERPNext's existing <code>Subscription</code> DocType from accounts module</p>"},{"location":"implementation/#3-universal-tenant_id-patch","title":"3. Universal tenant_id Patch","text":"<p>Location: <code>saas_platform/patches/add_tenant_id_to_all_tables.py</code></p> <p>What it does: - Adds <code>tenant_id VARCHAR(140) DEFAULT 'SYSTEM'</code> to ALL DocTypes - Uses <code>ALTER TABLE</code> for performance (direct SQL, not Frappe Custom Field) - Processes both parent tables (istable=0) and child tables (istable=1) - Creates indexes on tenant_id for query performance - Registered in <code>patches.txt</code> to run on <code>bench migrate</code></p> <p>Execution: Runs automatically during migration, adds tenant_id to ~200+ tables</p>"},{"location":"implementation/#4-auto-tenant_id-population","title":"4. Auto tenant_id Population","text":"<p>Location: <code>saas_platform/utils.py</code></p> <p>Functions: - <code>set_tenant_id(doc, method)</code>: Hooks into <code>before_insert</code> for ALL DocTypes - <code>sync_child_table_tenant_id(doc, tenant_id)</code>: Copies parent's tenant_id to all child rows - <code>get_user_tenant_id()</code>: Retrieves current user's tenant_id from User custom field - <code>get_tenant_from_email(email)</code>: Utility to lookup tenant by email</p> <p>Behavior: - Auto-sets tenant_id based on authenticated user - Defaults to \"SYSTEM\" for Administrator or users without tenant - Syncs tenant_id to all child table rows automatically</p>"},{"location":"implementation/#5-tenant-data-isolation","title":"5. Tenant Data Isolation","text":"<p>Location: <code>saas_platform/permissions.py</code></p> <p>Functions: - <code>get_tenant_query(user)</code>: Returns SQL condition for permission filtering - <code>get_tenant_query_for_doctype(doctype)</code>: DocType-specific query builder - <code>has_permission(doc, ptype, user)</code>: Additional document-level permission check</p> <p>Isolation Rules: - Users can only see records where <code>tenant_id IN (user_tenant, 'SYSTEM')</code> - \"SYSTEM\" tenant_id = shared data (Plans, UOMs, Item Groups, etc.) - Administrator bypasses all tenant filters - Fail-secure: If error, shows nothing</p>"},{"location":"implementation/#6-hooks-configuration","title":"6. Hooks Configuration","text":"<p>Location: <code>saas_platform/hooks.py</code></p> <p>Registered Hooks: <pre><code># Document events - auto-populate tenant_id\ndoc_events = {\n    \"*\": {\n        \"before_insert\": \"saas_platform.utils.set_tenant_id\",\n    }\n}\n\n# Permission query conditions - data isolation\npermission_query_conditions = {\n    \"*\": \"saas_platform.permissions.get_tenant_query\",\n}\n\n# Has permission - additional checks\nhas_permission = {\n    \"*\": \"saas_platform.permissions.has_permission\",\n}\n\n# Fixtures - load default plans\nfixtures = [\n    {\n        \"doctype\": \"Plan\",\n        \"filters\": [[\"tenant_id\", \"=\", \"SYSTEM\"]]\n    }\n]\n</code></pre></p>"},{"location":"implementation/#how-it-works","title":"How It Works","text":""},{"location":"implementation/#signup-flow","title":"Signup Flow","text":"<ol> <li>User signs up via signup-service API</li> <li>Service creates Tenant document</li> <li><code>Tenant.before_insert()</code> generates unique tenant_id</li> <li><code>Tenant.validate()</code> checks uniqueness</li> <li>Tenant saved to database</li> <li><code>Tenant.after_insert()</code> triggered:</li> <li>Creates ERPNext Company (e.g., \"Acme Corp - AC\")</li> <li>Creates Subscription (Free Plan, 14-day trial)</li> <li>Links Company and Subscription back to Tenant</li> </ol>"},{"location":"implementation/#data-isolation","title":"Data Isolation","text":"<ol> <li>User logs in</li> <li>Every database query filtered by:</li> <li><code>WHERE tenant_id IN ('user-tenant-id-123', 'SYSTEM')</code></li> <li>User sees:</li> <li>Their own tenant's data</li> <li>Shared SYSTEM data (Plans, UOMs, etc.)</li> <li>Administrator sees everything (no filter)</li> </ol>"},{"location":"implementation/#document-creation","title":"Document Creation","text":"<ol> <li>User creates Sales Order</li> <li><code>before_insert</code> hook fires</li> <li><code>set_tenant_id()</code> called:</li> <li>Gets user's tenant_id from User.tenant_id</li> <li>Sets <code>doc.tenant_id = 'user-tenant-id-123'</code></li> <li>Syncs tenant_id to all child table items</li> <li>Document saved with tenant_id</li> <li>Only users from same tenant can see it</li> </ol>"},{"location":"implementation/#migration-steps","title":"Migration Steps","text":""},{"location":"implementation/#to-apply-this-implementation","title":"To Apply This Implementation:","text":"<ol> <li> <p>Install saas_platform app:    <pre><code>bench get-app /path/to/saas_platform\nbench --site dev.localhost install-app saas_platform\n</code></pre></p> </li> <li> <p>Run migrations (adds tenant_id to all tables):    <pre><code>bench --site dev.localhost migrate\n</code></pre>    This will:</p> </li> <li>Create Plan DocType</li> <li>Update Tenant DocType</li> <li>Run ALTER TABLE patch on ~200+ tables</li> <li> <p>Load default Plan fixtures</p> </li> <li> <p>Add tenant_id custom field to User DocType (for storing user-tenant relationship):    <pre><code>bench --site dev.localhost console\n</code></pre> <pre><code># In bench console\nfrom frappe.custom.doctype.custom_field.custom_field import create_custom_fields\n\ncustom_fields = {\n    \"User\": [\n        {\n            \"fieldname\": \"tenant_id\",\n            \"fieldtype\": \"Data\",\n            \"label\": \"Tenant ID\",\n            \"insert_after\": \"email\",\n            \"read_only\": 1,\n            \"hidden\": 1\n        }\n    ]\n}\ncreate_custom_fields(custom_fields)\n</code></pre></p> </li> <li> <p>Update signup-service to set user's tenant_id when creating User</p> </li> <li> <p>Restart services:    <pre><code>bench restart\n</code></pre></p> </li> </ol>"},{"location":"implementation/#testing","title":"Testing","text":""},{"location":"implementation/#verify-tenant_id-columns","title":"Verify tenant_id columns:","text":"<pre><code>SHOW COLUMNS FROM `tabSales Order` LIKE 'tenant_id';\nSHOW COLUMNS FROM `tabUser` LIKE 'tenant_id';\n</code></pre>"},{"location":"implementation/#test-isolation","title":"Test isolation:","text":"<ol> <li>Create Tenant: Should auto-create Company and Subscription</li> <li>Create User with tenant_id</li> <li>Login as that user</li> <li>Create Sales Order: Should auto-set tenant_id</li> <li>Query Sales Orders: Should only see own tenant's orders + SYSTEM</li> </ol>"},{"location":"implementation/#check-plans","title":"Check Plans:","text":"<pre><code>frappe.get_all(\"Plan\", fields=[\"*\"])\n# Should return 3 plans with tenant_id=\"SYSTEM\"\n</code></pre>"},{"location":"implementation/#performance-considerations","title":"Performance Considerations","text":"<ul> <li>Indexes: All tenant_id columns have indexes for fast filtering</li> <li>ALTER TABLE: Used for one-time migration speed</li> <li>Query overhead: Every query now has <code>WHERE tenant_id IN (...)</code> clause</li> <li>Future optimization: Consider partitioning tables by tenant_id for large installations</li> </ul>"},{"location":"implementation/#security-notes","title":"Security Notes","text":"<ul> <li>Fail-secure: Permission errors default to showing nothing</li> <li>Administrator bypass: Admin can manage all tenants</li> <li>SYSTEM tenant: Shared reference data accessible to all</li> <li>No data leakage: Strict tenant_id enforcement on all queries</li> </ul>"},{"location":"implementation/#next-steps","title":"Next Steps","text":"<ol> <li>Update signup-service to create User with tenant_id</li> <li>Test complete signup \u2192 Company \u2192 Subscription flow</li> <li>Add upgrade/downgrade subscription logic</li> <li>Implement plan limit enforcement (max_users, max_storage_gb)</li> <li>Add tenant admin dashboard</li> <li>Consider adding tenant-level settings/configuration</li> </ol>"},{"location":"installation/","title":"Installation Guide","text":""},{"location":"installation/#getting-started","title":"Getting Started","text":"<p>The <code>saas_platform</code> app is designed to be installed on a Frappe Bench that acts as the Central Site for your SaaS ecosystem.</p>"},{"location":"installation/#prerequisites","title":"Prerequisites","text":"<ul> <li>A working Frappe Bench environment.</li> <li>ERPNext (v15 recommended).</li> </ul>"},{"location":"installation/#1-install-the-app","title":"1. Install the App","text":"<pre><code># From your frappe-bench directory\nbench get-app https://github.com/varun-krishnamurthy/saas_platform.git\nbench --site your-site-name.localhost install-app saas_platform\n</code></pre>"},{"location":"installation/#2-configure-database-columns","title":"2. Configure Database Columns","text":"<p>The app includes a utility to add the <code>tenant_id</code> column to all tables in your database. This is a one-time setup step.</p> <pre><code># Run the migration utility\nbench --site your-site-name.localhost execute saas_platform.patches.add_tenant_id_to_all_tables.execute\n</code></pre>"},{"location":"installation/#3-add-custom-fields","title":"3. Add Custom Fields","text":"<p>Ensure all core DocTypes have the <code>tenant_id</code> field added:</p> <pre><code>bench --site your-site-name.localhost execute saas_platform.utils.add_custom_fields.execute\n</code></pre>"},{"location":"installation/#4-restart-bench","title":"4. Restart Bench","text":"<pre><code>bench restart\n</code></pre>"},{"location":"installation/#verification","title":"Verification","text":"<ol> <li>Log in to your site.</li> <li>Check the User DocType; a read-only <code>tenant_id</code> field should now be present.</li> <li>Every new record created will now automatically inherit the user's <code>tenant_id</code>.</li> </ol>"},{"location":"integration/","title":"Microservice Integration Guide","text":"<p>This document explains how the <code>saas_platform</code> app on the Central Site enables the Frappe Microservice ecosystem.</p>"},{"location":"integration/#overview","title":"Overview","text":"<p>The Frappe Microservice Framework depends on <code>saas_platform</code> for two primary reasons: 1.  Shared Authentication: Users log in once to the Central Site and access microservices via the same session. 2.  Tenant Identification: Microservices rely on the <code>tenant_id</code> field managed by <code>saas_platform</code> to enforce data isolation.</p>"},{"location":"integration/#role-of-saas_platform","title":"Role of <code>saas_platform</code>","text":""},{"location":"integration/#1-unified-user-schema","title":"1. Unified User Schema","text":"<p><code>saas_platform</code> adds a <code>tenant_id</code> field to the <code>User</code> DocType on the Central Site. This field is the \"anchor\" for multi-tenancy. When a microservice receives a request, it: - Validates the session against the Central Site. - Queries the Central Site's <code>tabUser</code> table to find the <code>tenant_id</code> for that specific user.</p>"},{"location":"integration/#2-session-hook","title":"2. Session Hook","text":"<p>The app includes an <code>on_session_creation</code> hook (hooks.py) that ensures the <code>tenant_id</code> is loaded into the user's session metadata immediately upon login.</p> <pre><code># saas_platform/hooks.py\non_session_creation = \"saas_platform.utils.tenant.on_session_creation\"\n</code></pre>"},{"location":"integration/#integration-checklist-for-microservices","title":"Integration Checklist for Microservices","text":"<p>When building a microservice that connects to a Central Site running <code>saas_platform</code>:</p> <ul> <li>Central Site URL: Ensure the <code>CENTRAL_SITE_URL</code> environment variable is correctly set in your microservice.</li> <li>User Availability: The user must exist and be <code>enabled</code> on the Central Site.</li> <li>Tenant Assignment: The user MUST have a valid <code>tenant_id</code> assigned in their user profile on the Central Site. Users with a <code>SYSTEM</code> or null <code>tenant_id</code> will be rejected by the microservice as a security precaution.</li> </ul>"},{"location":"integration/#technical-flow","title":"Technical Flow","text":"<pre><code>sequenceDiagram\n    participant User\n    participant MS as Microservice\n    participant CS as Central Site (saas_platform)\n    participant DB as Service Database\n\n    User-&gt;&gt;CS: Login &amp; Get Session Cookie (sid)\n    User-&gt;&gt;MS: Request API + sid\n    MS-&gt;&gt;CS: GET /api/method/frappe.auth.get_logged_user (validate sid)\n    CS--&gt;&gt;MS: 200 OK (username)\n    MS-&gt;&gt;CS: SELECT tenant_id FROM tabUser WHERE name = {username}\n    CS--&gt;&gt;MS: {tenant_id}\n    MS-&gt;&gt;DB: SELECT * FROM {Table} WHERE tenant_id = {tenant_id}\n    DB--&gt;&gt;MS: Isolated Data\n    MS--&gt;&gt;User: Response</code></pre>"},{"location":"integration/#troubleshooting","title":"Troubleshooting","text":"<ol> <li>\"No tenant_id found\": Ensure the <code>saas_platform</code> app is correctly installed on the Central Site and that the <code>tenant_id</code> field is visible in the User DocType.</li> <li>Session Rejected: Check if the <code>sid</code> cookie is being passed correctly between domains (if applicable).</li> </ol>"}]}